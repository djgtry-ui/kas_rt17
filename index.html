<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catatan Keuangan Kas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ==================================================== */
        /* DARK THEME STYLES */
        /* ==================================================== */
        :root {
            /* Warna Dasar */
            --color-primary: #3b82f6; /* Blue-500 */
            --color-text-light: #f3f4f6; /* Gray-100 */
            --color-card-bg: rgba(48, 68, 96, 0.7); /* Semi-transparent dark for glass effect */
            --color-card-border: rgba(255, 255, 255, 0.1);
            --color-table-header-bg: rgba(55, 65, 81, 0.7); /* Gray-700 semi-transparent */
        }
        
        body {
            /* Latar belakang gelap dengan gradien */
            background-color: #111827; 
            background-image: radial-gradient(at 50% 10%, #1e3a8a, #111827);
            color: var(--color-text-light);
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
        }
        .card {
            background-color: var(--color-card-bg);
            border: 1px solid var(--color-card-border);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        .table-header {
            background-color: var(--color-table-header-bg);
        }
        .btn-primary {
            background-color: var(--color-primary);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Penyesuaian Tinggi Chart untuk Mobile */
        #monthlyChart {
            height: 300px; /* Tinggi tetap untuk mobile */
        }
        @media (min-width: 768px) {
            #monthlyChart {
                height: 400px; /* Lebih tinggi di desktop */
            }
        }

        /* Warna Khusus Login Screen (Sesuai permintaan gambar) */
        #loginScreen .login-card {
            background-color: #091535; /* Gray-800 */
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
            color: var(--color-text-light);
        }
        #loginScreen .input-field {
            background-color: #374151; /* Gray-700 */
            border: 1px solid #4b5563; /* Gray-600 */
            color: white;
        }
        #loginScreen .login-icon {
            background-color: var(--color-primary);
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="login-card rounded-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="login-icon w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                </div>
                <h1 class="text-3xl font-bold text-white">Kas RT 17t</h1>
            </div>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="username" class="block text-gray-400 font-medium mb-2">Username</label>
                    <input type="text" id="username" class="input-field w-full px-4 py-2 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-400 font-medium mb-2">Password</label>
                    <input type="password" id="password" class="input-field w-full px-4 py-2 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <button type="submit" id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    Login
                </button>
            </form>
            <div class="text-center mb-8 text-gray-400 text-sm">
            </div>
            <div class="text-center mb-5 text-gray-600 text-sm">
            Made By Nur Djaya Atmaja
            </div>
            <p id="loginMessage" class="text-center mt-4 text-sm text-red-400 hidden"></p>
        </div>
    </div>

    <div id="dashboardScreen" class="hidden min-h-screen p-4 lg:p-8">
        <header class="flex flex-col lg:flex-row justify-between items-center mb-6 lg:mb-8">
            <h1 class="text-3xl lg:text-4xl font-bold mb-4 lg:mb-0 text-white">Informasi Kas</h1>
            <div class="flex space-x-2 w-full lg:w-auto justify-end">
                <button id="adminActionBtn" class="btn-primary flex-grow lg:flex-grow-0 px-4 py-2 rounded-lg font-semibold shadow-md flex items-center justify-center space-x-2 hover:bg-blue-700 transition duration-200 text-sm lg:text-base hidden">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    <span class="hidden md:inline">Tambah Transaksi</span>
                    <span class="md:hidden">Tambah</span>
                </button>
                <button id="logoutBtn" class="bg-gray-600 px-4 py-2 rounded-lg font-semibold shadow-md flex items-center justify-center space-x-2 hover:bg-gray-700 transition duration-200 text-white text-sm lg:text-base">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span class="hidden md:inline">Logout</span>
                </button>
            </div>
        </header>

        <div class="card p-3 lg:p-4 rounded-xl mb-6 flex justify-between items-center max-w-lg mx-auto">
            <button id="prevMonthBtn" class="text-white hover:text-blue-400 transition duration-150 p-1 lg:p-2">
                <svg class="w-5 h-5 lg:w-6 lg:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <h2 id="currentMonthDisplay" class="text-lg lg:text-2xl font-bold text-white">Loading...</h2>
            <button id="nextMonthBtn" class="text-white hover:text-blue-400 transition duration-150 p-1 lg:p-2">
                <svg class="w-5 h-5 lg:w-6 lg:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 lg:gap-4 mb-6 lg:mb-8">
            <div class="card p-4 rounded-xl text-center">
                <p class="text-xs lg:text-sm text-gray-400">Saldo Awal</p>
                <p id="statStartingBalance" class="text-lg lg:text-2xl font-bold text-green-400 mt-1">Rp 0</p>
            </div>
            <div class="card p-4 rounded-xl text-center">
                <p class="text-xs lg:text-sm text-gray-400">Pemasukan</p>
                <p id="statTotalIncome" class="text-lg lg:text-2xl font-bold text-green-400 mt-1">Rp 0</p>
            </div>
            <div class="card p-4 rounded-xl text-center">
                <p class="text-xs lg:text-sm text-gray-400">Pengeluaran</p>
                <p id="statTotalExpense" class="text-lg lg:text-2xl font-bold text-red-400 mt-1">Rp 0</p>
            </div>
            <div class="card p-4 rounded-xl text-center col-span-2 md:col-span-1">
                <p class="text-xs lg:text-sm text-gray-400">Saldo Akhir Global</p>
                <p id="statBalance" class="text-lg lg:text-2xl font-bold text-yellow-400 mt-1">Rp 0</p>
            </div>
        </div>

        <div class="flex justify-center space-x-3 lg:space-x-4 mb-6 lg:mb-8">
            <button id="toggleChartBtn" class="bg-blue-600 text-white px-3 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 text-sm">Tampilkan Grafik</button>
            <button id="toggleTableBtn" class="bg-gray-600 text-white px-3 py-2 rounded-lg font-semibold hover:bg-gray-700 transition duration-200 text-sm">Tampilkan Tabel</button>
        </div>

        <div id="chartContainer" class="card p-4 lg:p-6 rounded-xl mb-4 fade-in">
            <canvas id="monthlyChart"></canvas>
            <div id="chartError" class="text-center text-gray-400 mt-4 hidden">Tidak ada data untuk grafik di bulan ini.</div>
        </div>
        
        <div class="text-center mb-8 text-gray-600 text-sm">
            Made By Nur Djaya Atmaja
        </div>

        <div id="tableContainer" class="card p-2 lg:p-4 rounded-xl overflow-x-auto hidden fade-in">
            <h3 class="text-lg lg:text-xl font-semibold mb-4 text-white p-2">Riwayat Transaksi Bulanan</h3>
            <table class="min-w-full table-auto">
                <thead>
                    <tr>
                        <th class="table-header px-2 py-2 text-left rounded-tl-lg text-sm lg:text-base">Tgl</th>
                        <th class="table-header px-2 py-2 text-left text-sm lg:text-base">Keterangan</th>
                        <th class="table-header px-2 py-2 text-right text-sm lg:text-base">Pemasukan</th>
                        <th class="table-header px-2 py-2 text-right text-sm lg:text-base">Pengeluaran</th>
                        <th class="table-header px-2 py-2 text-right text-sm lg:text-base">Saldo</th>
                        <th class="table-header px-2 py-2 text-center rounded-tr-lg text-sm lg:text-base">Aksi</th>
                    </tr>
                </thead>
                <tbody id="transactionTableBody" class="divide-y divide-gray-700 text-xs lg:text-sm text-gray-300">
                    <tr>
                        <td colspan="6" class="text-center py-4">Loading data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-5 w-full max-w-lg">
            <h3 id="modalTitle" class="text-xl lg:text-2xl font-bold mb-5 text-white">Tambah Transaksi Baru</h3>
            <form id="transactionForm">
                <input type="hidden" id="transactionAction" value="add">
                <input type="hidden" id="transactionId">
                
                <div class="mb-3">
                    <label for="transactionDate" class="block text-gray-400 font-medium mb-1 text-sm">Tanggal</label>
                    <input type="date" id="transactionDate" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                
                <div class="mb-3">
                    <label for="transactionDescription" class="block text-gray-400 font-medium mb-1 text-sm">Keterangan</label>
                    <input type="text" id="transactionDescription" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                
                <div class="mb-3">
                    <label for="transactionIncome" class="block text-gray-400 font-medium mb-1 text-sm">Pemasukan (Rp)</label>
                    <input type="number" id="transactionIncome" min="0" value="0" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm focus:ring-green-500 focus:border-green-500">
                </div>
                
                <div class="mb-4">
                    <label for="transactionExpense" class="block text-gray-400 font-medium mb-1 text-sm">Pengeluaran (Rp)</label>
                    <input type="number" id="transactionExpense" min="0" value="0" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm focus:ring-red-500 focus:border-red-500">
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelBtn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-200 text-sm">Batal</button>
                    <button type="submit" id="saveBtn" class="btn-primary text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 text-sm">Simpan Transaksi</button>
                </div>
            </form>
            <button id="deleteBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200 w-full mt-3 text-sm hidden">Hapus Transaksi</button>
        </div>
    </div>
    
    <script>
        // ===============================================
        // KONSTANTA DAN VARIABEL GLOBAL (HARAP GANTI URL!)
        // ===============================================
        
        // GANTI INI dengan URL Web Apps Script Anda yang sudah di-deploy sebagai "Anyone"
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzMhgoci8bhJF6uuvXWlLI-pffhQxTZefj7qsPEs60qGnfgUaoS-cSeLR-7gkIunMwy/exec'; 
        
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", 
                            "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        
        let currentMonth; 
        let currentYear;
        let financeChart; 

        // === PERUBAHAN KRITIS: Kredensial Role-Based ===
        
        let userRole = 'user'; // Default role
        // ===============================================

        // ===============================================
        // FUNGIONALITAS UI
        // ===============================================
        
        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }

        function closeModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        function openAddModal() {
            if (userRole !== 'admin') return; // Hanya Admin yang bisa menambah
            
            document.getElementById('modalTitle').textContent = 'Tambah Transaksi Baru';
            document.getElementById('transactionAction').value = 'add';
            document.getElementById('transactionId').value = '';
            document.getElementById('transactionDate').value = new Date().toISOString().substring(0, 10);
            document.getElementById('transactionDescription').value = '';
            document.getElementById('transactionIncome').value = '0';
            document.getElementById('transactionExpense').value = '0';
            document.getElementById('saveBtn').textContent = 'Simpan Transaksi';
            document.getElementById('deleteBtn').classList.add('hidden');
            document.getElementById('editModal').classList.remove('hidden');
        }

        function openEditModal(transaction) {
            if (userRole !== 'admin') return; // Hanya Admin yang bisa mengedit
            
            document.getElementById('modalTitle').textContent = 'Edit Transaksi';
            document.getElementById('transactionAction').value = 'edit';
            document.getElementById('transactionId').value = transaction.id;
            document.getElementById('transactionDate').value = transaction.date; 
            document.getElementById('transactionDescription').value = transaction.description;
            document.getElementById('transactionIncome').value = transaction.income;
            document.getElementById('transactionExpense').value = transaction.expense;
            document.getElementById('saveBtn').textContent = 'Perbarui Transaksi';
            
            document.getElementById('deleteBtn').classList.remove('hidden');
            document.getElementById('deleteBtn').onclick = () => handleDelete(transaction.id);
            document.getElementById('editModal').classList.remove('hidden');
        }

        function toggleDisplay(mode) {
            const chart = document.getElementById('chartContainer');
            const table = document.getElementById('tableContainer');
            const chartBtn = document.getElementById('toggleChartBtn');
            const tableBtn = document.getElementById('toggleTableBtn');

            if (mode === 'chart') {
                chart.classList.remove('hidden');
                table.classList.add('hidden');
                chartBtn.classList.add('bg-blue-600', 'text-white');
                chartBtn.classList.remove('bg-gray-600', 'text-white');
                tableBtn.classList.add('bg-gray-600', 'text-white');
                tableBtn.classList.remove('bg-blue-600', 'text-white');
            } else if (mode === 'table') {
                chart.classList.add('hidden');
                table.classList.remove('hidden');
                tableBtn.classList.add('bg-blue-600', 'text-white');
                tableBtn.classList.remove('bg-gray-600', 'text-white');
                chartBtn.classList.add('bg-gray-600', 'text-white');
                chartBtn.classList.remove('bg-blue-600', 'text-white');
            }
        }

        // ===============================================
        // FUNGSI UPDATE DATA 
        // ===============================================
        
        function updateStats(stats) {
            document.getElementById('statStartingBalance').textContent = formatRupiah(stats.startingBalance);
            document.getElementById('statTotalIncome').textContent = formatRupiah(stats.totalIncome);
            document.getElementById('statTotalExpense').textContent = formatRupiah(stats.totalExpense);
            document.getElementById('statBalance').textContent = formatRupiah(stats.balance);
        }

        function updateTable(transactions) {
            const tbody = document.getElementById('transactionTableBody');
            tbody.innerHTML = '';
            
            if (transactions.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-400">Tidak ada transaksi di bulan ini.</td></tr>`;
                return;
            }

            transactions.forEach(tx => {
                const tr = document.createElement('tr');
                tr.classList.add('hover:bg-gray-700', 'transition', 'duration-150');
                
                const formattedDate = new Date(tx.date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                const incomeClass = tx.income > 0 ? 'text-green-400' : 'text-gray-400';
                const expenseClass = tx.expense > 0 ? 'text-red-400' : 'text-gray-400';

                // === PERUBAHAN KRITIS: Tombol Aksi berdasarkan Role ===
                const actionButton = userRole === 'admin' ? 
                    `<button class="text-blue-400 hover:text-blue-300 font-medium text-sm" onclick='openEditModal(${JSON.stringify(tx)})'>Edit</button>` :
                    `<span class="text-gray-500 text-sm">Lihat</span>`;

                tr.innerHTML = `
                    <td class="px-2 py-2">${formattedDate}</td>
                    <td class="px-2 py-2 max-w-xs truncate">${tx.description}</td>
                    <td class="px-2 py-2 text-right font-semibold ${incomeClass}">${formatRupiah(tx.income)}</td>
                    <td class="px-2 py-2 text-right font-semibold ${expenseClass}">${formatRupiah(tx.expense)}</td>
                    <td class="px-2 py-2 text-right font-semibold text-yellow-400">${formatRupiah(tx.balance)}</td>
                    <td class="px-2 py-2 text-center">
                        ${actionButton}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function updateChart(chartData, month, year) {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            const errorElement = document.getElementById('chartError');
            
            if (chartData.income.every(val => val === 0) && chartData.expense.every(val => val === 0)) {
                errorElement.classList.remove('hidden');
                if (financeChart) financeChart.destroy(); 
                return;
            } else {
                errorElement.classList.add('hidden');
            }

            if (financeChart) {
                financeChart.destroy(); 
            }

            financeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Pemasukan',
                            data: chartData.income,
                            backgroundColor: 'rgba(52, 211, 153, 0.8)', 
                            borderColor: 'rgba(52, 211, 153, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        },
                        {
                            label: 'Pengeluaran',
                            data: chartData.expense,
                            backgroundColor: 'rgba(248, 113, 113, 0.8)', 
                            borderColor: 'rgba(248, 113, 113, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    scales: {
                        x: {
                            stacked: false,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'white' },
                            title: { display: true, text: `Hari di Bulan ${monthNames[month - 1]}`, color: 'white' }
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { 
                                color: 'white',
                                callback: function(value) { return formatRupiah(value); } 
                            },
                            title: { display: true, text: 'Jumlah (Rp)', color: 'white' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: 'white' } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) { label += formatRupiah(context.parsed.y); }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ===============================================
        // FUNGSI KOMUNIKASI API
        // ===============================================

        async function fetchMonthlyData(month, year) {
            document.getElementById('currentMonthDisplay').textContent = `${monthNames[month - 1]} ${year}`;
            document.getElementById('transactionTableBody').innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-400">Memuat data...</td></tr>`;

            try {
                const url = `${SCRIPT_URL}?action=getMonthlyData&month=${month}&year=${year}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.error) {
                    console.error('Error dari Apps Script:', data.error);
                    alert(`Gagal memuat data: ${data.error}`);
                    document.getElementById('currentMonthDisplay').textContent = `ERROR`;
                    return;
                }
                
                updateStats(data.stats);
                updateTable(data.transactions);
                updateChart(data.chartData, month, year);

            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('transactionTableBody').innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-400">Gagal terhubung ke Apps Script. Cek URL dan Deployment.</td></tr>`;
            }
        }
        
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            if (userRole !== 'admin') return; // Tambahkan pencegahan di sisi client

            const action = document.getElementById('transactionAction').value;
            const transactionId = document.getElementById('transactionId').value;
            
            const income = parseFloat(document.getElementById('transactionIncome').value) || 0;
            const expense = parseFloat(document.getElementById('transactionExpense').value) || 0;
            
            if (income > 0 && expense > 0) {
                 alert("Transaksi tidak boleh memiliki Pemasukan dan Pengeluaran secara bersamaan.");
                 return;
            }
            if (income === 0 && expense === 0) {
                 alert("Anda harus mengisi Pemasukan atau Pengeluaran.");
                 return;
            }

            const payload = {
                action: action,
                id: transactionId,
                date: document.getElementById('transactionDate').value,
                description: document.getElementById('transactionDescription').value,
                income: income,
                expense: expense
            };

            document.getElementById('saveBtn').textContent = 'Memproses...';
            document.getElementById('saveBtn').disabled = true;

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    closeModal();
                    fetchMonthlyData(currentMonth, currentYear); 
                } else {
                    alert('Gagal: ' + result.message);
                }

            } catch (error) {
                console.error('Error POST:', error);
                alert('Gagal terhubung ke server Apps Script.');
            } finally {
                document.getElementById('saveBtn').textContent = action === 'add' ? 'Simpan Transaksi' : 'Perbarui Transaksi';
                document.getElementById('saveBtn').disabled = false;
            }
        }
        
        async function handleDelete(id) {
            if (userRole !== 'admin') return; // Tambahkan pencegahan di sisi client
            if (!confirm("Apakah Anda yakin ingin menghapus transaksi ini?")) return;

            const payload = { action: 'delete', id: id };
            
            document.getElementById('deleteBtn').textContent = 'Memproses...';
            document.getElementById('deleteBtn').disabled = true;

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    closeModal();
                    fetchMonthlyData(currentMonth, currentYear); 
                } else {
                    alert('Gagal menghapus: ' + result.message);
                }
            } catch (error) {
                 alert('Gagal terhubung ke server Apps Script.');
            } finally {
                 document.getElementById('deleteBtn').textContent = 'Hapus Transaksi';
                 document.getElementById('deleteBtn').disabled = false;
            }
        }


        // ===============================================
        // INIALISASI APLIKASI
        // ===============================================

        function initializeDashboard() {
            const today = new Date();
            currentMonth = today.getMonth() + 1; 
            currentYear = today.getFullYear();
            fetchMonthlyData(currentMonth, currentYear); 

            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.remove('hidden');
            document.getElementById('dashboardScreen').classList.add('fade-in');

            // === PERUBAHAN KRITIS: Tampilkan tombol Admin hanya untuk role 'admin' ===
            if (userRole === 'admin') {
                document.getElementById('adminActionBtn').classList.remove('hidden');
            } else {
                 document.getElementById('adminActionBtn').classList.add('hidden');
            }

            toggleDisplay('chart');
        }

        // ===============================================
        // EVENT LISTENERS
        // ===============================================

        // Login Handler
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const msg = document.getElementById('loginMessage');
            const loginBtn = document.getElementById('loginBtn');

            msg.classList.add('hidden');
            loginBtn.textContent = 'Memverifikasi...';
            loginBtn.disabled = true;

            const payload = {
                action: 'login', // Action baru untuk Apps Script
                username: username,
                password: password
            };

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });

                 // Handling response jika server tidak mengembalikan JSON yang valid
                if (response.headers.get('content-type').indexOf('application/json') === -1) {
                    throw new Error("Respon Apps Script tidak valid. Kemungkinan 'Deployment access' salah.");
                }

                const result = await response.json();

                if (result.success) {
                    userRole = result.role; // Set role dari hasil Apps Script
                    initializeDashboard();
                } else {
                    msg.textContent = result.message || 'Login gagal. Cek kredensial Anda.';
                    msg.classList.remove('hidden');
                }

            } catch (error) {
                console.error('Login Error:', error);
                msg.textContent = 'Gagal terhubung ke server. Cek koneksi atau URL Apps Script.';
                msg.classList.remove('hidden');
            } finally {
                loginBtn.textContent = 'Login';
                loginBtn.disabled = false;
            }
        });
        
        // Logout Handler
        document.getElementById('logoutBtn').addEventListener('click', function() {
            userRole = 'user';
            document.getElementById('dashboardScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginScreen').classList.add('fade-in');
            document.getElementById('loginForm').reset();
        });

        // Form Transaksi Handler (Add/Edit)
        document.getElementById('transactionForm').addEventListener('submit', handleFormSubmit);

        // Modal Handlers
        document.getElementById('cancelBtn').addEventListener('click', closeModal);
        document.getElementById('adminActionBtn').addEventListener('click', openAddModal); 

        // Navigasi Bulan
        document.getElementById('prevMonthBtn').addEventListener('click', function() {
            currentMonth--;
            if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            fetchMonthlyData(currentMonth, currentYear);
        });

        document.getElementById('nextMonthBtn').addEventListener('click', function() {
            currentMonth++;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            }
            fetchMonthlyData(currentMonth, currentYear);
        });

        // Toggle Chart/Table
        document.getElementById('toggleChartBtn').addEventListener('click', () => toggleDisplay('chart'));
        document.getElementById('toggleTableBtn').addEventListener('click', () => toggleDisplay('table'));

        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
             const today = new Date();
             document.getElementById('transactionDate').value = today.toISOString().substring(0, 10);
        });

    </script>
</body>

</html>
